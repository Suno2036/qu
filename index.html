<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Свадебная фотобудка Ильи и Алины</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for a modern, luxurious feel */
        body {
            font-family: 'Poppins', sans-serif;
            touch-action: manipulation;
            background: linear-gradient(to bottom right, #0a0a0a, #1a1a1a);
        }
        .font-wedding-title {
            font-family: 'Dancing Script', cursive;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1rem;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            z-index: 50;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .hidden {
            display: none;
        }
        .bg-glass {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gray-900 flex flex-col min-h-screen text-gray-200">

    <!-- Splash screen with logo -->
    <div id="splash-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50 transition-opacity duration-1000">
        <img src="https://placehold.co/200x200/B8860B/ffffff?text=LOGO" alt="Logo" class="animate-pulse mb-8 rounded-full">
        <p class="text-xl text-gray-400">Загрузка...</p>
    </div>

    <!-- Main application content (initially hidden) -->
    <div id="main-app-content" class="hidden flex-grow flex flex-col">
        <!-- Header and description -->
        <header class="text-center p-6 bg-glass rounded-b-3xl shadow-lg sticky top-0 z-10">
            <h1 class="font-wedding-title text-5xl sm:text-6xl font-bold text-pink-400">
                Илья & Алина
            </h1>
            <p class="mt-2 text-gray-400 text-sm sm:text-base">
                Оставьте нам свое фото на память!
            </p>
        </header>

        <main class="flex-grow p-4 sm:p-6 flex flex-col items-center">
            <!-- Photo booth section (main camera) -->
            <div id="camera-section" class="w-full max-w-2xl mt-8 mb-8 bg-glass rounded-3xl shadow-xl p-4 sm:p-6 fade-in">
                <h2 class="text-3xl font-bold text-center mb-4 text-pink-400">Сделать фото</h2>
                <!-- Camera view -->
                <div class="w-full relative overflow-hidden rounded-xl mb-4" style="padding-top: 75%;">
                    <video id="camera-view" class="absolute inset-0" playsinline autoplay></video>
                    <div id="countdown" class="absolute inset-0 flex items-center justify-center text-white text-9xl font-bold opacity-0 transition-opacity duration-300"></div>
                </div>
                <!-- Control buttons -->
                <div class="flex justify-center items-center space-x-4">
                    <button id="capture-btn" class="flex-grow py-3 px-6 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 text-lg font-semibold">
                        Сделать фото
                    </button>
                </div>
            </div>

            <!-- Photo gallery section -->
            <div id="photos-container" class="w-full max-w-4xl mt-6">
                <h2 class="text-3xl font-bold text-center mb-6 text-pink-400">Галерея</h2>
                <div id="photo-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 fade-in">
                    <!-- Photos will be added here -->
                    <p class="text-center text-gray-500 col-span-full">Загрузка фотографий...</p>
                </div>
            </div>
        </main>

        <!-- Notification message -->
        <div id="message-box" class="message-box text-center p-6 bg-white rounded-xl shadow-lg border-2 border-gray-200 hidden">
            <p id="message-box-text" class="text-gray-700 font-medium"></p>
        </div>

        <!-- Footer -->
        <footer class="text-center p-4 text-gray-500 text-sm">
            &copy; 2024 Свадебная фотобудка. Все права защищены.
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Main script
        document.addEventListener('DOMContentLoaded', async () => {
            // UI elements
            const splashScreen = document.getElementById('splash-screen');
            const mainAppContent = document.getElementById('main-app-content');
            const photosContainer = document.getElementById('photo-grid');
            const captureBtn = document.getElementById('capture-btn');
            const cameraView = document.getElementById('camera-view');
            const countdown = document.getElementById('countdown');
            const messageBox = document.getElementById('message-box');
            const messageBoxText = document.getElementById('message-box-text');

            // App state
            let db;
            let auth;
            let userId;

            // Initialize Firebase with your keys
            const firebaseConfig = {
              apiKey: "AIzaSyBojX_FBhea41ITHrheVaQFucPyn2r6gS4",
              authDomain: "svadba-31c48.firebaseapp.com",
              projectId: "svadba-31c48",
              storageBucket: "svadba-31c48.firebasestorage.app",
              messagingSenderId: "1052874829050",
              appId: "1:1052874829050:web:fe27036bfce06d0d496d43",
              measurementId: "G-JC9ENZPZ96"
            };

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;
                console.log("Firebase signed in anonymously. User ID:", userId);
                setupPhotoListener();
            } catch (e) {
                console.error("Firebase auth error:", e);
                showMessage("Ошибка аутентификации. Пожалуйста, перезагрузите страницу.", false);
                captureBtn.disabled = true;
                // Still try to init camera even if Firebase auth fails
                init();
            }

            // Initialize the camera with high-quality settings
            async function init() {
                let stream;
                try {
                    // Request high resolution, good frame rate, and continuous focus
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            frameRate: { ideal: 30 },
                            advanced: [{ focusMode: 'continuous' }]
                        }
                    });
                } catch (err) {
                    console.error("Error accessing rear camera, attempting to use front: ", err);
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                    } catch (e) {
                        showMessage("Ошибка: Не удалось получить доступ к камере. Пожалуйста, разрешите доступ.", false);
                        console.error("Camera access error: ", e);
                        captureBtn.disabled = true;
                        // Hide splash screen and show main content even on error
                        hideSplashScreen();
                        return;
                    }
                }
                
                if (stream) {
                    cameraView.srcObject = stream;
                    cameraView.play();
                    // Hide splash screen after successful camera initialization
                    hideSplashScreen();
                } else {
                    showMessage("Ошибка: Не удалось получить доступ к камере.", false);
                    captureBtn.disabled = true;
                    // Hide splash screen and show main content even on error
                    hideSplashScreen();
                }
            }
            
            // Function to hide the splash screen and show the main content
            function hideSplashScreen() {
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.classList.add('hidden');
                    mainAppContent.classList.remove('hidden');
                }, 1000); // Wait for the fade-out animation
            }

            // Show and hide messages
            function showMessage(text, isTemporary = true) {
                messageBoxText.textContent = text;
                messageBox.classList.remove('hidden');
                if (isTemporary) {
                    setTimeout(() => {
                        messageBox.classList.add('hidden');
                    }, 3000);
                }
            }

            // Countdown timer
            function startCountdown() {
                let count = 3;
                countdown.textContent = count;
                countdown.classList.remove('opacity-0');

                const timer = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdown.textContent = count;
                    } else {
                        clearInterval(timer);
                        countdown.textContent = '';
                        countdown.classList.add('opacity-0');
                        takePhoto();
                    }
                }, 1000);
            }

            // Take a photo and save to Firestore
            async function takePhoto() {
                const canvas = document.createElement('canvas');
                const videoWidth = cameraView.videoWidth;
                const videoHeight = cameraView.videoHeight;

                canvas.width = videoWidth;
                canvas.height = videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(cameraView, 0, 0, videoWidth, videoHeight);

                const imageDataUrl = canvas.toDataURL('image/jpeg');
                
                showMessage("Загрузка фото...", false);
                captureBtn.disabled = true;

                try {
                    // Save photo to Firestore database
                    const photosRef = collection(db, `wedding-photos`);
                    await addDoc(photosRef, {
                        photoData: imageDataUrl,
                        timestamp: new Date().toISOString(),
                    });
                    showMessage("Фото успешно загружено!", true);
                } catch (e) {
                    showMessage("Ошибка при загрузке фото. Попробуйте еще раз.", true);
                    console.error("Error adding document: ", e);
                } finally {
                    captureBtn.disabled = false;
                }
            }
            
            // Set up listener to display photos in real-time
            function setupPhotoListener() {
                const photosRef = collection(db, `wedding-photos`);
                const q = query(photosRef, limit(10)); // Display the 10 most recent photos
            
                // We sort the data on the client side since orderBy may require an index
                onSnapshot(q, (querySnapshot) => {
                    const photos = [];
                    querySnapshot.forEach((doc) => {
                        photos.push({ id: doc.id, ...doc.data() });
                    });

                    // Sort photos by timestamp in descending order
                    photos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    photosContainer.innerHTML = ''; // Clear container before updating
                    if (photos.length > 0) {
                        photos.forEach((photo) => {
                            displayPhoto(photo.photoData);
                        });
                    } else {
                        photosContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">Фотографий пока нет.</p>';
                    }
                });
            }

            // Display a photo
            function displayPhoto(dataUrl) {
                const photoWrapper = document.createElement('div');
                photoWrapper.className = 'relative group rounded-xl overflow-hidden shadow-lg transition-transform transform hover:scale-105';
                
                const img = document.createElement('img');
                img.src = dataUrl;
                img.className = 'w-full h-auto object-cover rounded-xl';
                
                // Add photo to the container
                photoWrapper.appendChild(img);
                photosContainer.prepend(photoWrapper);
            }

            // Event handlers
            captureBtn.addEventListener('click', () => {
                startCountdown();
            });
        });
    </script>
</body>
</html>
