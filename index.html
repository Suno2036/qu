<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Свадебная фотобудка Ильи и Алины</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Базовые стили для современного, роскошного вида */
        body {
            font-family: 'Poppins', sans-serif;
            touch-action: manipulation;
            background: linear-gradient(to bottom right, #0a0a0a, #1a1a1a);
        }
        .font-wedding-title {
            font-family: 'Dancing Script', cursive;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1rem;
            transform: scaleX(-1); /* Зеркальное отображение для селфи */
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            z-index: 50;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .hidden {
            display: none;
        }
        .bg-glass {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gray-900 flex flex-col min-h-screen text-gray-200">

    <!-- Заставка с логотипом -->
    <div id="splash-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50 transition-opacity duration-1000">
        <img src="https://placehold.co/200x200/B8860B/ffffff?text=IA" alt="Logo" class="animate-pulse mb-8 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/200x200/000000/FFFFFF?text=Error';">
        <p class="text-xl text-gray-400">Загрузка...</p>
    </div>

    <!-- Основное содержимое приложения (изначально скрыто) -->
    <div id="main-app-content" class="hidden flex-grow flex flex-col">
        <!-- Заголовок и описание -->
        <header class="text-center p-6 bg-glass rounded-b-3xl shadow-lg sticky top-0 z-10">
            <h1 class="font-wedding-title text-5xl sm:text-6xl font-bold text-pink-400">
                Илья & Алина
            </h1>
            <p class="mt-2 text-gray-400 text-sm sm:text-base">
                Оставьте нам свое фото на память!
            </p>
        </header>

        <main class="flex-grow p-4 sm:p-6 flex flex-col items-center">
            <!-- Секция фотобудки (основная камера) -->
            <div id="camera-section" class="w-full max-w-2xl mt-8 mb-8 bg-glass rounded-3xl shadow-xl p-4 sm:p-6 fade-in">
                <h2 class="text-3xl font-bold text-center mb-4 text-pink-400">Сделать фото</h2>
                <!-- Вид с камеры -->
                <div class="w-full relative overflow-hidden rounded-xl mb-4" style="padding-top: 75%;">
                    <video id="camera-view" class="absolute inset-0" playsinline autoplay></video>
                    <div id="countdown" class="absolute inset-0 flex items-center justify-center text-white text-9xl font-bold opacity-0 transition-opacity duration-300"></div>
                </div>
                <!-- Кнопки управления -->
                <div class="flex justify-center items-center space-x-4">
                    <button id="capture-btn" class="flex-grow py-3 px-6 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 text-lg font-semibold">
                        Сделать фото
                    </button>
                </div>
            </div>

            <!-- Секция фотогалереи -->
            <div id="photos-container" class="w-full max-w-4xl mt-6">
                <h2 class="text-3xl font-bold text-center mb-6 text-pink-400">Галерея</h2>
                <div id="photo-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 fade-in">
                    <!-- Фотографии будут добавлены сюда -->
                    <p class="text-center text-gray-500 col-span-full">Загрузка фотографий...</p>
                </div>
            </div>
        </main>

        <!-- Уведомление -->
        <div id="message-box" class="message-box text-center p-6 hidden">
            <p id="message-box-text" class="font-medium"></p>
        </div>

        <!-- Футер -->
        <footer class="text-center p-4 text-gray-500 text-sm">
            &copy; 2024 Свадебная фотобудка. Все права защищены.
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Основной скрипт
        document.addEventListener('DOMContentLoaded', () => {
            // Элементы пользовательского интерфейса
            const splashScreen = document.getElementById('splash-screen');
            const mainAppContent = document.getElementById('main-app-content');
            const photosContainer = document.getElementById('photo-grid');
            const captureBtn = document.getElementById('capture-btn');
            const cameraView = document.getElementById('camera-view');
            const countdown = document.getElementById('countdown');
            const messageBox = document.getElementById('message-box');
            const messageBoxText = document.getElementById('message-box-text');

            // Состояние приложения
            let db;
            let auth;
            let userId;
            let appInitialized = false; // Флаг для предотвращения повторной инициализации
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Используем предоставленную средой конфигурацию Firebase, если она доступна
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
              // ВАШИ КЛЮЧИ FIREBASE (если не предоставляются средой)
              apiKey: "YOUR_API_KEY",
              authDomain: "YOUR_AUTH_DOMAIN",
              projectId: "YOUR_PROJECT_ID",
              storageBucket: "YOUR_STORAGE_BUCKET",
              messagingSenderId: "YOUR_SENDER_ID",
              appId: "YOUR_APP_ID"
            };

            // Инициализируем сервисы Firebase
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Функция для скрытия заставки и отображения основного содержимого
            function hideSplashScreen() {
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.classList.add('hidden');
                    mainAppContent.classList.remove('hidden');
                }, 1000); // Ожидание анимации затухания
            }

            // Показать и скрыть сообщения
            function showMessage(text, isTemporary = true) {
                messageBoxText.textContent = text;
                messageBox.classList.remove('hidden');
                if (isTemporary) {
                    setTimeout(() => {
                        messageBox.classList.add('hidden');
                    }, 3000);
                }
            }

            // Инициализация всего приложения
            async function initApp() {
                if (appInitialized) return; // Если уже инициализировано, выходим
                appInitialized = true;

                try {
                    await initCamera();
                    setupPhotoListener();
                    hideSplashScreen();
                } catch (e) {
                    console.error("Ошибка инициализации приложения:", e);
                    let errorMsg = "Ошибка инициализации.";
                    if (e.name === 'NotAllowedError') {
                        errorMsg = "Доступ к камере отклонен. Пожалуйста, разрешите доступ в настройках браузера.";
                    } else if (e.name === 'NotFoundError') {
                        errorMsg = "Камера не найдена на этом устройстве.";
                    } else if (e.name === 'NotReadableError') {
                        errorMsg = "Камера используется другим приложением.";
                    }
                    showMessage(errorMsg, false);
                    hideSplashScreen(); // Показываем интерфейс, чтобы пользователь увидел ошибку
                }
            }

            // Слушатель состояния аутентификации
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Пользователь вошел в систему.
                    userId = user.uid;
                    console.log("Пользователь аутентифицирован:", userId);
                    initApp(); // Запускаем приложение
                } else {
                    // Пользователь не вошел в систему.
                    console.log("Пользователь не аутентифицирован, попытка анонимного входа.");
                }
            });

            // Функция для попытки входа
            async function attemptSignIn() {
                try {
                    // Сначала проверяем, есть ли уже пользователь
                    if (auth.currentUser) {
                         console.log("Найден существующий пользователь.");
                         initApp(); // Если да, сразу инициализируем
                         return;
                    }
                    // Если пользователя нет, пытаемся войти
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    // onAuthStateChanged обработает успешный вход и вызовет initApp
                } catch (error) {
                    console.error("Ошибка аутентификации Firebase:", error);
                    showMessage("Ошибка аутентификации. Пожалуйста, перезагрузите страницу.", false);
                    captureBtn.disabled = true;
                    hideSplashScreen(); // Показываем интерфейс для отображения ошибки
                }
            }
            
            // Запускаем процесс входа
            attemptSignIn();


            // Инициализация камеры
            async function initCamera() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("Ваш браузер не поддерживает доступ к камере.");
                }
                
                let stream;
                // Сначала пытаемся получить доступ к передней камере (для селфи)
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'user',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        } 
                    });
                } catch (err) {
                    console.warn("Ошибка доступа к передней камере, попытка использовать заднюю:", err);
                    // Если не получилось, пробуем заднюю
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    } catch (e) {
                        throw e; // Если обе попытки провалились
                    }
                }
                
                if (stream) {
                    cameraView.srcObject = stream;
                    await cameraView.play();
                } else {
                    throw new Error("Не удалось получить поток с камеры.");
                }
            }
            
            // Таймер обратного отсчета
            function startCountdown() {
                captureBtn.disabled = true;
                let count = 3;
                countdown.textContent = count;
                countdown.classList.remove('opacity-0');

                const timer = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdown.textContent = count;
                    } else {
                        clearInterval(timer);
                        countdown.textContent = '📸'; // Смайлик в момент съемки
                        takePhoto();
                        setTimeout(() => {
                           countdown.classList.add('opacity-0');
                           captureBtn.disabled = false;
                        }, 1000);
                    }
                }, 1000);
            }

            // Сделать фото и сохранить в Firestore
            async function takePhoto() {
                const canvas = document.createElement('canvas');
                const videoWidth = cameraView.videoWidth;
                const videoHeight = cameraView.videoHeight;

                canvas.width = videoWidth;
                canvas.height = videoHeight;
                const context = canvas.getContext('2d');

                // Учитываем зеркальное отображение
                context.translate(videoWidth, 0);
                context.scale(-1, 1);
                context.drawImage(cameraView, 0, 0, videoWidth, videoHeight);

                const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9); // Сжатие JPEG
                
                showMessage("Загрузка фото...", false);

                try {
                    const photosRef = collection(db, `artifacts/${appId}/public/data/wedding-photos`);
                    await addDoc(photosRef, {
                        photoData: imageDataUrl,
                        timestamp: new Date().toISOString(),
                    });
                    showMessage("Фото успешно загружено!", true);
                } catch (e) {
                    showMessage("Ошибка при загрузке фото. Попробуйте еще раз.", true);
                    console.error("Ошибка добавления документа: ", e);
                }
            }
            
            // Настроить слушатель для отображения фотографий в реальном времени
            function setupPhotoListener() {
                const photosRef = collection(db, `artifacts/${appId}/public/data/wedding-photos`);
                const q = query(photosRef, limit(50)); 
            
                onSnapshot(q, (querySnapshot) => {
                    const photos = [];
                    querySnapshot.forEach((doc) => {
                        photos.push({ id: doc.id, ...doc.data() });
                    });

                    // Сортируем фотографии по дате (от новых к старым)
                    photos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    photosContainer.innerHTML = ''; // Очищаем контейнер
                    if (photos.length > 0) {
                        photos.forEach((photo) => {
                            displayPhoto(photo.photoData);
                        });
                    } else {
                        photosContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">Фотографий пока нет. Будьте первыми!</p>';
                    }
                });
            }

            // Отобразить фотографию
            function displayPhoto(dataUrl) {
                const photoWrapper = document.createElement('div');
                photoWrapper.className = 'relative group rounded-xl overflow-hidden shadow-lg transition-transform transform hover:scale-105';
                
                const img = document.createElement('img');
                img.src = dataUrl;
                img.className = 'w-full h-auto object-cover rounded-xl';
                img.loading = 'lazy'; // Ленивая загрузка для производительности
                
                photoWrapper.appendChild(img);
                photosContainer.appendChild(photoWrapper); // Используем append, так как сортируем массив заранее
            }

            // Обработчики событий
            captureBtn.addEventListener('click', () => {
                if (!auth.currentUser) {
                    showMessage("Пожалуйста, подождите, идет аутентификация...", true);
                    return;
                }
                startCountdown();
            });
        });
    </script>
</body>
</html>
